name: Multi Docker Image Build and Push to ECR

on:
  push:
    branches: ["compose-dhlee"]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: AWS ì¸ì¦ ì •ë³´ ë“±ë¡
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2 # â† ë³¸ì¸ ë¦¬ì „ ì½”ë“œë¡œ ë°”ê¿”!

      - name: ECR ë¡œê·¸ì¸
        uses: aws-actions/amazon-ecr-login@v2

      - name: ì—¬ëŸ¬ ì„œë¹„ìŠ¤ ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ & í‘¸ì‹œ
        env:
          ECR_REGISTRY: 908027399356.dkr.ecr.ap-northeast-2.amazonaws.com # â† ë³¸ì¸ ì •ë³´ë¡œ ë°”ê¿”!
        run: |
          SERVICES="config-service discovery-service gateway-service point-service restaurant-service review-service user-service" # â† ì˜¬ë¦´ ì„œë¹„ìŠ¤ í´ë”/ì´ë¦„ë“¤! ì§ì ‘ ìˆ˜ì •

          for SERVICE in $SERVICES
          do
            echo "===== $SERVICE ë¹Œë“œ ë° í‘¸ì‹œ ì‹œì‘ ====="
            # ë„ì»¤ ë¹Œë“œ (ê° ì„œë¹„ìŠ¤ í´ë” ê¸°ì¤€ìœ¼ë¡œ)
            docker build -t $SERVICE:${GITHUB_SHA} ./back/$SERVICE

            # ECRìš© íƒœê·¸
            docker tag $SERVICE:${GITHUB_SHA} $ECR_REGISTRY/$SERVICE:${GITHUB_SHA}
            docker tag $SERVICE:${GITHUB_SHA} $ECR_REGISTRY/$SERVICE:latest

            # í‘¸ì‹œ
            docker push $ECR_REGISTRY/$SERVICE:${GITHUB_SHA}
            docker push $ECR_REGISTRY/$SERVICE:latest
            echo "===== $SERVICE í‘¸ì‹œ ì™„ë£Œ ====="
          done
      # ğŸ”¥ ì—¬ê¸°ì„œë¶€í„° composeë¥¼ í†µí•œ ì „ì²´ ì„œë¹„ìŠ¤ ì¬ë°°í¬
      - name: Config Service application-dev.yml ì£¼ì…
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            mkdir -p /home/ubuntu/config-service-tmp
            cat << 'EOF' > /home/ubuntu/config-service-tmp/application-dev.yml
            ${{ secrets.CONFIG_SERVICE_DEV_YML }}
            EOF
      - name: EC2ì—ì„œ ECR ë¡œê·¸ì¸
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            aws ecr get-login-password --region ap-northeast-2 | docker login --username AWS --password-stdin 908027399356.dkr.ecr.ap-northeast-2.amazonaws.com

      - name: ì „ì²´ ì„œë¹„ìŠ¤ docker-composeë¡œ ì¬ë°°í¬
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/reviewing-msa/back # â† docker-compose.yml ìœ„ì¹˜ë¡œ ì´ë™!
            docker-compose pull
            docker-compose down
            docker-compose up -d

            # (ì„ íƒ) ìƒíƒœ í™•ì¸
            docker-compose ps
